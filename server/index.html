<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <title>Food Planner</title>
<link rel="stylesheet" href="/static/style.css">
<link rel="icon" type="image/svg+xml" href="/favicon.svg">
</head>
<body>
  <a href="/add" class="add-link">Додати страву</a>

  <div class="container">
    <div class="tabs">
      <a href="/" class="tab-btn active">Що поїсти</a>
      <a href="#" class="tab-btn">Рекомендації</a>
      <a href="/feedback" class="tab-btn">Зворотній зв'язок</a>
    </div>
    <h1>Food Planner</h1>
    <div>
      <b>Оберіть категорію:</b>
      <div id="categoryBtns"></div>
      <button id="randomBtn">Що поїсти?</button>
    </div>
    <div id="randomDish"></div>
  </div>

  <script>
    const categories = [
      { key: 'breakfasts', name: 'Сніданки' },
      { key: 'lunches', name: 'Обіди' },
      { key: 'dinners', name: 'Вечері' },
      { key: 'snacks', name: 'Перекуси' }
    ];
    let selectedCategory = categories[0].key;

    function renderCategoryButtons() {
      const container = document.getElementById('categoryBtns');
      container.innerHTML = '';
      categories.forEach(cat => {
        const btn = document.createElement('button');
        btn.textContent = cat.name;
        btn.className = 'tab-btn' + (cat.key === selectedCategory ? ' active' : '');
        btn.onclick = function() {
          selectedCategory = cat.key;
          renderCategoryButtons();
        };
        container.appendChild(btn);
      });
    }

    async function fetchDishes(category) {
      const res = await fetch(`/dishes/${category}`);
      return res.ok ? await res.json() : [];
    }

    function safeHtml(html) {
      const allowed = /<(\/)?(table|tr|td|th|tbody|thead|tfoot|b|i|u|br|pre)>/gi;
      return html
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(allowed, function(m) {
          return m.replace('&lt;', '<').replace('&gt;', '>');
        });
    }

    document.getElementById('randomBtn').onclick = async function() {
      const dishes = await fetchDishes(selectedCategory);
      const box = document.getElementById('randomDish');
      if (dishes.length === 0) {
        box.innerHTML = '<b>Немає страв у цій категорії.</b>';
        return;
      }
      const dish = dishes[Math.floor(Math.random() * dishes.length)];
      let imgHtml = '';
      if (dish.image_url) {
        let img = dish.image_url;
        if (!img.startsWith('/images/')) img = '/images/' + img.replace(/^\/+/, '');
        imgHtml = `<img src="${img}" alt="Зображення" style="max-width:300px;display:block;margin:18px auto;">`;
      }
      const recipeHtml = `<pre style='text-align:left;'>${safeHtml(dish.recipe)}</pre>`;
      const dishHtml = `<h2>${dish.name}</h2>${imgHtml}<p><b>Калорії:</b> ${dish.calories}</p><b>Рецепт:</b> ${recipeHtml}`;
      box.innerHTML = `<div class="dish-animate">${dishHtml}</div>`;
    };

    renderCategoryButtons();
  </script>
</body>
</html>
